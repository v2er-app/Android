# V2er 回复排序和楼中楼功能说明

## 功能概述

本次更新为 V2er 添加了两个重要功能：

### 1. 回复按热门程度排序 (Reply Sorting by Popularity)

用户现在可以在主题页面切换回复的排序方式：
- **按时间排序** (默认) - 按回复时间顺序显示
- **按热门排序** - 按感谢次数降序排列，感谢次数相同时按楼层排序

#### 使用方法：
1. 在主题页面点击右上角菜单
2. 选择"按时间排序"或"按热门排序"来切换模式
3. 设置会自动保存，下次打开时保持选择的排序方式

### 2. 楼中楼功能 (Threaded Replies)

系统会自动检测回复中的 @用户名 提及，并以可视化方式显示回复的层级关系：

#### 特性：
- 自动解析 `@username` 和 `@<a href="/member/username">username</a>` 格式
- 根据提及关系计算缩进级别（最多3级）
- 有回复关系的评论会有：
  - 左侧缩进显示层级关系
  - 楼层号后显示 💬 图标
  - 浅色背景区分

## 技术实现

### 核心类修改：

1. **TopicInfo.java**
   - 添加 `processMentionsAndThreading()` 方法处理提及解析
   - 添加 `extractMentions()` 方法使用正则表达式提取用户名
   - 扩展 `getItems()` 方法支持排序模式参数

2. **TopicActivity.java**
   - 添加回复排序菜单项处理
   - 实现 `refreshReplySorting()` 方法即时切换排序
   - 集成排序模式状态管理

3. **TopicReplyItemDelegate.java**
   - 添加 `applyThreadIndentation()` 方法应用缩进样式
   - 集成楼层显示和线程指示器

4. **Reply 类增强**
   - 添加 `mentionedUsers` 列表存储提及的用户
   - 添加 `indentLevel` 字段控制缩进层级
   - 提供相关的 getter/setter 方法

### 新增组件：

- **ReplySortMode.java** - 排序模式枚举类
- **threaded_reply_background.xml** - 楼中楼回复背景样式
- **ic_sort.xml** - 排序功能图标

## 用户体验改进

1. **直观的可视化** - 通过缩进和背景色清晰显示回复层级
2. **状态持久化** - 排序偏好自动保存
3. **性能优化** - 本地排序，无需重新加载网络数据
4. **无侵入性** - 保持原有界面布局，仅添加新功能

## 示例场景

```
1楼: 原始问题
2楼: 直接回复问题
3楼: @2楼用户 我也有同样问题 💬  [缩进显示]
4楼: @3楼用户 试试这个方法 💬    [进一步缩进]
5楼: 新的话题
```

通过这种方式，用户可以更容易地跟踪对话线程和找到最受欢迎的回复。