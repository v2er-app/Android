name: Fastlane Deploy

on:
  workflow_dispatch:
    inputs:
      track:
        description: 'Deployment track'
        required: true
        type: choice
        default: 'internal'
        options:
          - internal
          - alpha
          - beta
          - production
      release_status:
        description: 'Release status'
        required: false
        type: choice
        default: 'draft'
        options:
          - draft
          - completed

jobs:
  deploy:
    name: Deploy with Fastlane
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Decode Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo "$KEYSTORE_BASE64" | base64 --decode > ${{ github.workspace }}/keystore.jks
        echo "KEYSTORE_PATH=${{ github.workspace }}/keystore.jks" >> $GITHUB_ENV
        
    - name: Setup Play Store credentials
      env:
        PLAY_STORE_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "$PLAY_STORE_SERVICE_ACCOUNT_JSON" > ${{ github.workspace }}/fastlane/play-store-key.json
        echo "PLAY_STORE_JSON_KEY_PATH=${{ github.workspace }}/fastlane/play-store-key.json" >> $GITHUB_ENV
        
    - name: Install Fastlane
      run: |
        bundle install
        bundle exec fastlane --version
        
    - name: Deploy to Play Store
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        SUPPLY_RELEASE_STATUS: ${{ github.event.inputs.release_status }}
      run: |
        case "${{ github.event.inputs.track }}" in
          internal)
            bundle exec fastlane android deploy_internal
            ;;
          alpha)
            bundle exec fastlane android deploy_alpha
            ;;
          beta)
            bundle exec fastlane android deploy_beta
            ;;
          production)
            bundle exec fastlane android deploy_production
            ;;
        esac
        
    - name: Clean up sensitive files
      if: always()
      run: |
        rm -f ${{ github.workspace }}/keystore.jks
        rm -f ${{ github.workspace }}/fastlane/play-store-key.json
        
    - name: Deployment Summary
      if: success()
      run: |
        echo "## Fastlane Deployment Complete :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Track**: ${{ github.event.inputs.track }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ github.event.inputs.release_status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: me.ghui.v2er" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[View in Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY